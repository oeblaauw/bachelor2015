<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<title>Canvas Drag and Drop Test</title>
<script type="text/javascript" src="fabric.js"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/bootstrap/3.3.0/css/bootstrap.min.css">
<style>
    #selectionMenu {
        padding: 10px;
    }
    #color-select {
        width: 50px;
        height: 20px;
        background-color: black;
        padding: 10px;
    };
</style>
</head>
<body>
    
<div style="float:right">
    <p>Last updated: 18.02.2015</p>

    <div id="selectionMenu" style="display:none">
        <h3>Valg:</h3>
        <button id="btn-delete" class="btn btn-default">Slett</button><br/>
         <select id="select-material">
          <option value="gips">Gips</option>
          <option value="tre">Tre</option>
          <option value="betong">Betong</option>
          <option value="glass">Glass</option>
        </select> 
        <!--<input id="txt-material" type="text" name="material">--><br/>
        <button onclick="updateOptions()">Oppdater</button>
    </div>
</div>
<div id="canvasWrapper">
    <canvas id="canvas" width="1200" height="800" style="margin:20px">
    This text is displayed if your browser does not support HTML5 Canvas.
    </canvas>
</div>
<script type="text/javascript">
    
    function updateOptions() {
        var selector = document.getElementById("select-material");
        var newMat = selector.options[selector.selectedIndex].value;
        var color;
        switch(newMat) {
            case 'gips':
                color = 'black';
                break;
            case 'tre':
                color = 'brown';
                break;
            case 'betong':
                color = 'gray';
                break;
            case 'glass':
                color = 'blue';
                break;
            default:
                color = 'black';
                break;
        }
        if(canvas.getActiveObject()) {
            var obj = canvas.getActiveObject();
            obj.set({
                material: newMat,
                stroke: color
            });
            canvas.renderAll();
        }
    }
//Declaring and initializing variables
var linesArray = [];    //Our lines that represents walls
var canvas = new fabric.Canvas('canvas', { selection: false, width: this.width, height: this.height });
var grid = 50;
var gridcolor = '#ccc';
var gridOptions = {
    stroke: '#ccc',
    strokeWidth: 1,
    selectable: false,
    evented: false
};
var objectSelected = false;

// adding a grid
for (var i = 0; i < (1200 / grid); i++) {
  canvas.add(new fabric.Line([ i * grid, 0, i * grid, 1200], gridOptions));
  canvas.add(new fabric.Line([ 0, i * grid, 1200, i * grid], gridOptions));
}

//When clicking down the mouse button
canvas.on('mouse:down', function(options){
    if(!objectSelected) {
        console.log("Drawing a new line");
        isDown = true;
        var pointer = canvas.getPointer(options.e);
        var pointX = Math.round(pointer.x/grid)*grid;
        var pointY = Math.round(pointer.y/grid)*grid;
        var points = [ pointX, pointY, pointX, pointY ];
        line = new fabric.Line(points, {
        strokeWidth: 5,
        stroke: 'black',
        selectable: false,
        lockScalingX: false,
        lockScalingY: false,
        lockUniScaling: false,
        lockScalingFlip: true,
        hasControls: true,
        strokeLineCap: 'square',
        perPixelTargetFind: true,   
        rotatingPointOffset: 50, //in pixels + offset
        visible: true,
        padding: 10,
        material: 'gips'
        }); 
        canvas.add(line);
     }
});


//When moving the mouse around
canvas.on('mouse:move', function(options){
  if (!isDown) return;
  if (objectSelected) return;
  
  //If here: Assuming we're drawing a line
  var pointer = canvas.getPointer(options.e);
  line.set({ x2: Math.round(pointer.x/grid)*grid, y2: Math.round(pointer.y/grid)*grid });
  canvas.renderAll();
});

//When releasing mouse button
canvas.on('mouse:up', function(options){
    isDown = false;
    if(objectSelected) return;
    
    //If objectSelected is false, we assume we have drawn a line
    //We don't want to add points, so line width, height or both must be > 0
    if(line.width > 0 || line.height > 0) {
        line.selectable = true;
        canvas.add(line);
        linesArray.push(line);
    }
    console.log(linesArray);
});

//When mouse is hovering an object
canvas.on('mouse:over', function(options) {
    //if(options.target !== null) hoverObject = true;
});

//When mouse hovering off an object
canvas.on('mouse:out', function(options) {
   //hoverObject = false; 
}); 

//When an object is selected
canvas.on('object:selected', function(options) {
    objectSelected = true;
    document.getElementById("selectionMenu").style.display = 'inline';
});

//Selection cleared, or deselected an object
canvas.on('selection:cleared', function(options) {
    objectSelected = false;
    document.getElementById("selectionMenu").style.display = 'none';
});

//When moving an object
// snap to grid function
canvas.on('object:moving', function(options) { 
  options.target.set({
    left: Math.round(options.target.left / grid) * grid,
    top: Math.round(options.target.top / grid) * grid
  });
});

//Delete object function
var deleteSelectedObject = document.getElementById('btn-delete');
deleteSelectedObject.onclick = function() {
    var obj = canvas.getActiveObject();
    //Remove from linesArray
    for(var i=0; i < linesArray.length;i++) {
        if(linesArray[i] === obj) {
            linesArray.splice(i, 1);
        }
    }
    //Remove from canvas
    canvas.remove(obj);
    canvas.setActiveObject(obj);
    canvas.remove(obj);
};
</script>
</body>
</html>